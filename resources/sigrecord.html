<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>3Hz Complex Signal - 5% AWGN</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #f4f4f4; }
        .controls { background: white; padding: 20px; border-radius: 8px; display: inline-block; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px;}
        input { padding: 8px; width: 120px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; }
        
        canvas { background: #000; border: 2px solid #333; border-radius: 4px; margin-top: 20px; width: 100%; max-width: 800px; height: 250px; }
        
        .btn { display: inline-block; padding: 12px 24px; margin: 5px; font-weight: bold; color: white; background: #444; text-decoration: none; border-radius: 4px; border: none; cursor: pointer; }
        #start { background: #28a745; } #stop { background: #dc3545; } #save { background: #007bff; } #clear { background: #6c757d; }
        .btn.inactive { background: #ccc !important; color: #888; cursor: not-allowed; pointer-events: none; opacity: 0.6; }
        #status { font-family: monospace; margin-top: 15px; color: #333; line-height: 1.4; white-space: pre; }
        .legend { font-size: 0.9rem; margin-top: 5px; font-weight: bold; }
        .real { color: #00ff00; } .imag { color: #ff00ff; }
    </style>
</head>
<body>

    <h2>Complex IQ Signal Recorder (3 Hz + 5% AWGN)</h2>
  <p>Learning how to record signals. Mostly generated by Google Gemini</p>

    <div class="controls">
        <label>Sample Rate: </label>
        <input type="number" id="spsInput" value="1000" step="10" min="10"> <strong>SPS</strong>
    </div>

    <br>
    <button id="start" class="btn">Start Recording</button>
    <button id="stop" class="btn">Stop Recording</button>
    <a id="save" class="btn inactive">Save</a>
    <button id="clear" class="btn">Clear</button>

    <div id="status">Status: Idle | Samples: 0 | Time: 0.00s</div>
    
    <canvas id="scope"></canvas>
    <div class="legend">
        <span class="real">━ Real (I) + Noise</span> &nbsp;&nbsp; 
        <span class="imag">━ Imaginary (Q) + Noise</span>
    </div>

    <script>
        let chunks = [];
        let interval = null;
        let totalSamples = 0;
        const freq = 3; 
        const noiseSigma = 0.05; // 5% of signal amplitude
        
        let scopeBuffer = []; 
        const SCOPE_HISTORY_LIMIT = 5; 

        const canvas = document.getElementById('scope');
        const ctx = canvas.getContext('2d');
        const spsInput = document.getElementById('spsInput');
        const status = document.getElementById('status');
        const saveBtn = document.getElementById('save');

        canvas.width = 800;
        canvas.height = 250;

        function updateUI(msg) {
            const duration = totalSamples / (parseFloat(spsInput.value) || 1);
            status.innerText = `Status: ${msg}\nSamples: ${totalSamples.toLocaleString()}\nDuration: ${duration.toFixed(2)}s\nNoise: 5% AWGN`;
        }

        // Box-Muller transform for Gaussian Noise
        function gaussianRandom(mean=0, stdev=1) {
            const u = 1 - Math.random(); 
            const v = Math.random();
            const z = Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
            return z * stdev + mean;
        }

        function drawScope() {
            ctx.fillStyle = "black";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = "#333";
            ctx.beginPath(); ctx.moveTo(0, 125); ctx.lineTo(canvas.width, 125); ctx.stroke();

            const flatData = [];
            for (let chunk of scopeBuffer) {
                for (let val of chunk) flatData.push(val);
            }

            if (flatData.length === 0) return;
            const totalIQPairs = flatData.length / 2;
            const step = canvas.width / totalIQPairs;
            
            // Draw Real (Green)
            ctx.strokeStyle = "#00ff00";
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            for(let i=0; i < totalIQPairs; i++) {
                const x = i * step;
                const y = 125 - (flatData[i*2] * 100);
                i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            }
            ctx.stroke();

            // Draw Imaginary (Magenta)
            ctx.strokeStyle = "#ff00ff";
            ctx.beginPath();
            for(let i=0; i < totalIQPairs; i++) {
                const x = i * step;
                const y = 125 - (flatData[i*2 + 1] * 100);
                i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            }
            ctx.stroke();
        }

        document.getElementById('start').addEventListener('click', () => {
            if (interval) return;
            const sps = parseFloat(spsInput.value) || 1000;
            const samplesPerTick = sps / 10;

            saveBtn.classList.add('inactive');
            spsInput.disabled = true;
            updateUI("Recording...");

            interval = setInterval(() => {
                const buffer = new Float32Array(samplesPerTick * 2);
                for (let i = 0; i < samplesPerTick; i++) {
                    const t = (totalSamples + i) / sps;
                    const angle = 2 * Math.PI * freq * t;
                    
                    // Signal + AWGN
                    buffer[i * 2] = Math.cos(angle) + gaussianRandom(0, noiseSigma);
                    buffer[i * 2 + 1] = Math.sin(angle) + gaussianRandom(0, noiseSigma);
                }
                
                chunks.push(buffer.buffer);
                totalSamples += samplesPerTick;
                scopeBuffer.push(buffer);
                if (scopeBuffer.length > SCOPE_HISTORY_LIMIT) scopeBuffer.shift();

                drawScope();
                updateUI("Recording...");
            }, 100);
        });

        document.getElementById('stop').addEventListener('click', () => {
            if (!interval) return;
            clearInterval(interval);
            interval = null;
            spsInput.disabled = false;
            updateUI("Stopped");
            
            const blob = new Blob(chunks, { type: 'application/octet-stream' });
            if (saveBtn.href) URL.revokeObjectURL(saveBtn.href);
            saveBtn.href = URL.createObjectURL(blob);
            saveBtn.download = `complex_3Hz_AWGN_${spsInput.value}SPS.bin`;
            saveBtn.classList.remove('inactive');
        });

        document.getElementById('clear').addEventListener('click', () => {
            if (interval) clearInterval(interval);
            interval = null;
            chunks = [];
            scopeBuffer = [];
            totalSamples = 0;
            spsInput.disabled = false;
            if (saveBtn.href) URL.revokeObjectURL(saveBtn.href);
            saveBtn.href = "#";
            saveBtn.classList.add('inactive');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            updateUI("Idle (Cleared)");
        });
    </script>
</body>
</html>
